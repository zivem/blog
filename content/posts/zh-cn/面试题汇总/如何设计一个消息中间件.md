![消息中间件模型.png](assets/image-20220423153632-6w76p3k.png "消息中间件模型")

# 设计需要考虑的问题

* 消息如何存储？核心数据结构是什么？存内存还是磁盘？
* 存磁盘，同一个磁盘文件还是多个？磁盘文件如何拆分？如何标识数据的具体信息，offset还是内置id?
* 如何把消息投递到下游消费者？消费模型是什么？如何均匀的投放到多个消费者？

# 海量数据写入架构

![partition数据分片.png](assets/image-20220423154554-90q7a4r.png "partition数据分片")

## 问题

1. 数据是否需要分布式存储？
2. 数据分配是否需要支持扩容？
3. 是否支持数据自动负载均衡迁移？

# 数据宕机场景下高可用架构

某台机器宕机，数据是否丢失了？

> 分布式系统架构，需要采用多副本亢余机制，每个partition数据分片都是有多个副本的，任何一台机器宕机，丢失一个数据分片，还有其他机器上的副本分片在，可以支持数据不丢失
>

# 数据不丢失的ack机制

在这里你必须考虑两块ack机制，一个是生产端，一旦投递了消息，必须要求他将数据比如写入多个副本之后，才返回一个ack回调响应。

否则要是一直没收到ack的话，就需要重发一条消息过去，保证生产投递成功。

另外一个是消费端，一旦消费处理成功一条消息了，必须返回一个ack给消息中间件，然后消息中间件才能删除这条消息。

否则一旦消费者宕机，就必须重发这条消息给其他的消费者实例，保证消息一定会被处理成功。

这块如果大家不清楚，建议一定重看之前的系列文章，我们基于rabbitmq来阐述的这个数据不丢失的全链路ack机制。

![ack机制.png](assets/image-20220424141557-0xwvyyv.png "ack机制")
